
DROP TABLE VCG8_CP_SAIDA_RESUMIDA_CALC

CREATE TABLE VCG8_MOTO_DSPE_ALOC
(	COD_VERSAO SMALLINT,
	COD_ATIVIDADE BIGINT,
	COD_BLOCO_CONTA BIGINT,
	ID_CONTA BIGINT,
	COD_BLOCO_CENTRO BIGINT,
	ID_EMPRESA INT,
	TIPO_EMPRESA SMALLINT,
	ID_ORGAO BIGINT,
	VL_LANCAMENTO FLOAT,
	COD_TIPO_ORIGEM_PROCESSAMENTO SMALLINT
)

CREATE TABLE VCG8_CP_SAIDA_RESUMIDA_CALC
(		COD_VERSAO SMALLINT,
		COD_ATIVIDADE BIGINT,
	    COD_BLOCO_CONTA BIGINT,	
		COD_BLOCO_CENTRO BIGINT,
		ID_SUBCANAL_COMERC SMALLINT,
		COD_PROD_FIN INT,
		NT_EXPLICATIVA VARCHAR(10),
		VL_LANCAMENTO FLOAT
)

CREATE TABLE VCG8_MOTO_LANC_DEPA_SUM
(
	   [Codigo versao] SMALLINT,
	   [Codigo Tipo empresa consumidora] SMALLINT,
	   [Codigo Empresa Consumidora] SMALLINT,
	   [Codigo Orgao consumidor] SMALLINT,
	   [Codigo Atividade] BIGINT,
	   [Codigo Tipo Empresa fornecedora] SMALLINT,
	   [Codigo Orgao Fornecedor] SMALLINT,
	   [Valor Despesa custeio Origem] FLOAT,
	   [Valores Despesas Custeio Origem] FLOAT
)

--------------------- EXTRAÇÕES   -----------------------------------
SELECT  COD_VERSAO,
		COD_ATIVIDADE,
		COD_BLOCO_CONTA,
		ID_CONTA,
		COD_BLOCO_CENTRO,
		TIPO_EMPRESA,
		ID_ORGAO,
		VL_LANCAMENTO
FROM VCG8_MOTO_DSPE_ALOC 

SELECT  COD_VERSAO,
		COD_ATIVIDADE,
		COD_BLOCO_CONTA,
		COD_BLOCO_CENTRO,
		ID_SUBCANAL_COMERC,
		COD_PROD_FIN,
		VL_LANCAMENTO
FROM VCG8_CP_SAIDA_RESUMIDA_CALC
WHERE (VL_LANCAMENTO > 1 OR VL_LANCAMENTO < 1) AND NT_EXPLICATIVA IS NULL


SELECT  COD_VERSAO,
		COD_ATIVIDADE,
		COD_BLOCO_CONTA,
		COD_BLOCO_CENTRO,
		ID_SUBCANAL_COMERC,
		COD_PROD_FIN,
		VL_LANCAMENTO
		INTO #VCG8_CP_SAIDA_RESUMIDA_CALC_AJ_AGRUP
FROM VCG8_CP_SAIDA_RESUMIDA_CALC
WHERE (VL_LANCAMENTO > 1 AND VL_LANCAMENTO < 1) AND NT_EXPLICATIVA IS NULL

SELECT  COD_VERSAO,
		COD_ATIVIDADE,
		COD_BLOCO_CONTA,
		COD_BLOCO_CENTRO,
		ID_SUBCANAL_COMERC,
		COD_PROD_FIN,
		VL_LANCAMENTO
		INTO #VCG8_CP_SAIDA_RESUMIDA_CALC_AJ
FROM VCG8_CP_SAIDA_RESUMIDA_CALC
WHERE  NT_EXPLICATIVA IS NOT NULL

SELECT [Codigo versao],
	   [Codigo Tipo empresa consumidora],
	   [Codigo Empresa Consumidora],
	   [Codigo Orgao consumidor],
	   [Valores Despesas Custeio Origem]
from VCG8_MOTO_LANC_DEPA_SUM



SELECT
	  [Codigo Versao],
	  [Codigo Tipo Empresa Consumidora],
	  [Codigo Empresa Consumidora],
	  [Codigo Orgao consumidor],
	  [Codigo Atividade],
	  [Codigo Tipo Empresa fornecedora],
	  [Codigo Orgao Fornecedor],
	  [valor Despesa custeio Origem]
FROM VCG8_MOTO_LANC_DEPA_SUM

--------------------- DIRETOS (DEP + CP)   -----------------------------------

-- % DIRETO
--SELECT  QUEBRA.COD_VERSAO,
--		QUEBRA.COD_ATIVIDADE,
--		QUEBRA.COD_BLOCO_CONTA,
--		QUEBRA.ID_CONTA,
--		QUEBRA.COD_BLOCO_CENTRO,
--		QUEBRA.TIPO_EMPRESA,
--		QUEBRA.ID_EMPRESA,
--		QUEBRA.ID_ORGAO,
--		(QUEBRA.VL_LANCAMENTO/ TOTAL.VL_LANCAMENTO ) AS CALCULO_PERCENTUAL
--		INTO #TMP_DIRETOS
--FROM VCG8_MOTO_DSPE_ALOC AS QUEBRA INNER JOIN VCG8_MOTO_DSPE_ALOC AS TOTAL
--	ON  QUEBRA.COD_VERSAO        = TOTAL.COD_VERSAO        AND 
--		QUEBRA.COD_ATIVIDADE 	 = TOTAL.COD_ATIVIDADE     AND
--		QUEBRA.COD_BLOCO_CONTA   = TOTAL.COD_BLOCO_CONTA
--WHERE QUEBRA.COD_TIPO_ORIGEM_PROCESSAMENTO <> 5

--SELECT  CALC.COD_VERSAO,
--		CALC.COD_ATIVIDADE,
--		CALC.COD_BLOCO_CONTA,
--		CALC.ID_SUBCANAL_COMERC,
--		CALC.COD_PROD_FIN,
--		TMP.COD_BLOCO_CENTRO,
--		TMP.TIPO_EMPRESA,
--		TMP.ID_EMPRESA,
--		TMP.ID_ORGAO,
--		TMP.ID_CONTA,		
--		(VL_LANCAMENTO * CALCULO_PERCENTUAL) AS VL_LANCAMENTO_DIRETO
--		INTO #TMP_DIRETO
--FROM VCG8_CP_SAIDA_RESUMIDA_CALC CALC INNER JOIN #TMP_DIRETOS TMP
--	ON TMP.COD_VERSAO      = CALC.COD_VERSAO       AND 
--		TMP.COD_ATIVIDADE   = CALC.COD_ATIVIDADE    AND
--		TMP.COD_BLOCO_CONTA = CALC.COD_BLOCO_CONTA


SELECT   COD_VERSAO
		,COD_ATIVIDADE
		,COD_BLOCO_CONTA
		,ID_CONTA
		,COD_BLOCO_CENTRO
		,ID_EMPRESA
		,TIPO_EMPRESA
		,ID_ORGAO
		,SUM(VL_LANCAMENTO) AS VL_LANCAMENTO
		,SUM(SUM(VL_LANCAMENTO)) OVER (PARTITION BY COD_VERSAO,COD_ATIVIDADE,COD_BLOCO_CONTA) AS VL_LANCAMENTO_TOTAL_TOTAL
		, CONVERT(FLOAT,0) AS CALCULO_PERCENTUAL
		,COD_TIPO_ORIGEM_PROCESSAMENTO  
		INTO #TMP_DIRETOS
FROM VCG8_MOTO_DSPE_ALOC
GROUP BY COD_VERSAO
		,COD_ATIVIDADE
		,COD_BLOCO_CONTA
		,ID_CONTA
		,COD_BLOCO_CENTRO
		,ID_EMPRESA
		,TIPO_EMPRESA
		,ID_ORGAO
		,COD_TIPO_ORIGEM_PROCESSAMENTO
		
DELETE #TMP_DIRETOS WHERE VL_LANCAMENTO_TOTAL_TOTAL BETWEEN -1 AND 1 

UPDATE #TMP_DIRETOS SET CALCULO_PERCENTUAL = VL_LANCAMENTO_TOTAL_TOTAL /VL_LANCAMENTO

CREATE CLUSTERED INDEX #TMP_IND ON #TMP_DIRETOS (COD_VERSAO,COD_ATIVIDADE,COD_BLOCO_CONTA)

SELECT  CALC.COD_VERSAO,
		CALC.COD_ATIVIDADE,
		CALC.COD_BLOCO_CONTA,
		CALC.ID_SUBCANAL_COMERC,
		CALC.COD_PROD_FIN,	
		TMP.COD_BLOCO_CENTRO,
		TMP.TIPO_EMPRESA,
		TMP.ID_EMPRESA,
		TMP.ID_ORGAO,
		TMP.ID_CONTA,		
		(CALC.VL_LANCAMENTO * CALCULO_PERCENTUAL) AS VL_LANCAMENTO_DIRETO
		INTO #TMP_DIRETO
FROM VCG8_CP_SAIDA_RESUMIDA_CALC CALC INNER JOIN #TMP_DIRETOS TMP
	ON TMP.COD_VERSAO      = CALC.COD_VERSAO       AND 
	   TMP.COD_ATIVIDADE   = CALC.COD_ATIVIDADE    AND
	   TMP.COD_BLOCO_CONTA = CALC.COD_BLOCO_CONTA

--------------------- RECEBIDOS / INDIRETOS (DEP + CP)   -----------------------------------

	---- % RECEBIDO
	--SELECT  QUEBRA.COD_VERSAO,
	--	QUEBRA.COD_ATIVIDADE,
	--	QUEBRA.COD_BLOCO_CENTRO,
	--	QUEBRA.TIPO_EMPRESA,
	--	QUEBRA.ID_EMPRESA,
	--	QUEBRA.ID_ORGAO,
	--	(QUEBRA.VL_LANCAMENTO/ TOTAL.VL_LANCAMENTO ) AS CALCULO_PERCENTUAL_RECEBIDO
	--	INTO #TMP_RECEBIDOS
	--FROM VCG8_MOTO_DSPE_ALOC AS QUEBRA INNER JOIN VCG8_MOTO_DSPE_ALOC AS TOTAL
	--ON  QUEBRA.COD_VERSAO        = TOTAL.COD_VERSAO        AND 
	--	QUEBRA.COD_ATIVIDADE 	 = TOTAL.COD_ATIVIDADE     
	--WHERE QUEBRA.COD_TIPO_ORIGEM_PROCESSAMENTO <> 5

	---- %ORIGEM
	--SELECT
	--	QUEBRA.[Codigo Versao]                   AS COD_VERSAO,
	--	QUEBRA.[Codigo Tipo Empresa Consumidora] AS TIPO_EMPRESA_CONSUMIDORA,
	--	QUEBRA.[Codigo Empresa Consumidora]      AS ID_EMPRESA_CONSUMIDORA,
	--	QUEBRA.[Codigo Orgao consumidor]         AS ID_ORGAO_CONSUMIDORA,
	--	QUEBRA.[Codigo Atividade]                AS COD_ATIVIDADE,
	--	QUEBRA.[Codigo Tipo Empresa fornecedora] AS TIPO_EMPRESA_FORNECEDORA,
	--	QUEBRA.[Codigo Orgao Fornecedor]         AS ID_ORGAO_FORNECEDORA,
	--	(QUEBRA.[valor Despesa custeio Origem]/ TOTAL.[valor Despesa custeio Origem] ) AS CALCULO_PERCENTUAL_ORIGEM
	--	INTO #TMP_ORIGEM
	--FROM VCG8_MOTO_LANC_DEPA_SUM AS QUEBRA INNER JOIN VCG8_MOTO_LANC_DEPA_SUM AS TOTAL		
	--ON   QUEBRA.[Codigo Versao]                   = TOTAL.[Codigo Versao]                       AND 
	--		QUEBRA.[Codigo Tipo Empresa Consumidora] = TOTAL.[Codigo Tipo Empresa Consumidora]     AND
	--		QUEBRA.[Codigo Empresa Consumidora]      =	TOTAL.[Codigo Empresa Consumidora]          AND  
	--		QUEBRA.[Codigo Orgao consumidor]         = TOTAL.[Codigo Orgao consumidor]                      

		
	---- % RECEBIDOS E INDIRETOS
	--SELECT  CALC.COD_VERSAO,
	--	CALC.COD_ATIVIDADE,
	--	CALC.COD_BLOCO_CONTA,
	--	CALC.ID_SUBCANAL_COMERC,
	--	CALC.COD_PROD_FIN,
	--	REC.COD_BLOCO_CENTRO, 
	--	REC.TIPO_EMPRESA             AS TIPO_EMPRESA_RECEBIDO,        
	--	REC.ID_EMPRESA               AS ID_EMPRESA_RECEBIDO,    
	--	REC.ID_ORGAO                 AS ID_ORGAO_RECEBIDO, 
	----	TMP.ID_CONTA,		

	--	ORIG.TIPO_EMPRESA_CONSUMIDORA AS TIPO_EMPRESA_ORIGEM,
	--	ORIG.ID_EMPRESA_CONSUMIDORA   AS ID_EMPRESA_ORIGEM,
	--	ORIG.ID_ORGAO_CONSUMIDORA     AS ID_ORGAO_ORIGEM,

	--	(VL_LANCAMENTO * CALCULO_PERCENTUAL_ORIGEM * CALCULO_PERCENTUAL_RECEBIDO) AS VL_LANCAMENTO_RECEBIDO_INDIRETO

	--	INTO #TMP_RECEBIDO_INDIRETO
	--FROM VCG8_CP_SAIDA_RESUMIDA_CALC CALC INNER JOIN #TMP_RECEBIDOS REC
	--ON REC.COD_VERSAO           = CALC.COD_VERSAO       AND 
	--	REC.COD_ATIVIDADE        = CALC.COD_ATIVIDADE    AND
	--	REC.COD_BLOCO_CENTRO     = CALC.COD_BLOCO_CENTRO            INNER JOIN #TMP_ORIGEM ORIG
	--ON ORIG.COD_VERSAO          = CALC.COD_VERSAO       AND
	--	ORIG.COD_ATIVIDADE       = CALC.COD_ATIVIDADE    
	   
	   
SELECT   COD_VERSAO,
		 COD_ATIVIDADE,
		 COD_BLOCO_CENTRO,
		 TIPO_EMPRESA,
		 ID_EMPRESA,
		 ID_ORGAO
		,SUM(VL_LANCAMENTO) AS VL_LANCAMENTO
		,SUM(SUM(VL_LANCAMENTO)) OVER (PARTITION BY COD_VERSAO,COD_ATIVIDADE) AS VL_LANCAMENTO_TOTAL_TOTAL
		,CONVERT(FLOAT,0) AS CALCULO_PERCENTUAL_RECEBIDO
		INTO #TMP_RECEBIDOS
FROM VCG8_MOTO_DSPE_ALOC
WHERE QUEBRA.COD_TIPO_ORIGEM_PROCESSAMENTO <> 5
GROUP BY COD_VERSAO,
		 COD_ATIVIDADE,
		 COD_BLOCO_CENTRO,
		 TIPO_EMPRESA,
		 ID_EMPRESA,
		 ID_ORGAO
		
DELETE #TMP_RECEBIDOS WHERE VL_LANCAMENTO_TOTAL_TOTAL BETWEEN -1 AND 1 

UPDATE #TMP_RECEBIDOS SET CALCULO_PERCENTUAL_RECEBIDO = VL_LANCAMENTO_TOTAL_TOTAL /VL_LANCAMENTO

CREATE CLUSTERED INDEX #IDX_REC ON #TMP_RECEBIDOS (COD_VERSAO,COD_ATIVIDADE)



----

SELECT   [Codigo Versao]                   AS COD_VERSAO,
	     [Codigo Tipo Empresa Consumidora] AS TIPO_EMPRESA_CONSUMIDORA,
	     [Codigo Empresa Consumidora]      AS ID_EMPRESA_CONSUMIDORA,
	     [Codigo Orgao consumidor]         AS ID_ORGAO_CONSUMIDORA,
	     [Codigo Atividade]                AS COD_ATIVIDADE,
	     [Codigo Tipo Empresa fornecedora] AS TIPO_EMPRESA_FORNECEDORA,
	     [Codigo Orgao Fornecedor]         AS ID_ORGAO_FORNECEDORA
		,SUM([valor Despesa custeio Origem]) AS VL_LANCAMENTO
		,SUM(SUM([valor Despesa custeio Origem])) OVER (PARTITION BY COD_VERSAO,COD_ATIVIDADE) AS VL_LANCAMENTO_TOTAL_TOTAL
		,CONVERT(FLOAT,0) AS CALCULO_PERCENTUAL_ORIGEM
		INTO #TMP_ORIGEM
FROM VCG8_MOTO_DSPE_ALOC
WHERE QUEBRA.COD_TIPO_ORIGEM_PROCESSAMENTO <> 5
GROUP BY [Codigo Versao]                   
        ,[Codigo Tipo Empresa Consumidora] 
        ,[Codigo Empresa Consumidora]      
        ,[Codigo Orgao consumidor]         
        ,[Codigo Atividade]                
        ,[Codigo Tipo Empresa fornecedora] 
        ,[Codigo Orgao Fornecedor]         
		
DELETE #TMP_ORIGEM WHERE CALCULO_PERCENTUAL_ORIGEM BETWEEN -1 AND 1 

UPDATE #TMP_ORIGEM SET CALCULO_PERCENTUAL_ORIGEM = VL_LANCAMENTO_TOTAL_TOTAL /VL_LANCAMENTO

CREATE CLUSTERED INDEX #IDX_ORIGEM ON #TMP_RECEBIDOS (COD_VERSAO,COD_ATIVIDADE)





SELECT  CALC.COD_VERSAO,
		CALC.COD_ATIVIDADE,
		CALC.COD_BLOCO_CONTA,
		CALC.ID_SUBCANAL_COMERC,
		CALC.COD_PROD_FIN,
		REC.COD_BLOCO_CENTRO, 
		REC.TIPO_EMPRESA             AS TIPO_EMPRESA_RECEBIDO,        
		REC.ID_EMPRESA               AS ID_EMPRESA_RECEBIDO,    
		REC.ID_ORGAO                 AS ID_ORGAO_RECEBIDO, 
	--	TMP.ID_CONTA,		

	    ORIG.TIPO_EMPRESA_CONSUMIDORA AS TIPO_EMPRESA_ORIGEM,
		ORIG.ID_EMPRESA_CONSUMIDORA   AS ID_EMPRESA_ORIGEM,
		ORIG.ID_ORGAO_CONSUMIDORA     AS ID_ORGAO_ORIGEM,

		(VL_LANCAMENTO * CALCULO_PERCENTUAL_ORIGEM * CALCULO_PERCENTUAL_RECEBIDO) AS VL_LANCAMENTO_RECEBIDO_INDIRETO

		INTO #TMP_RECEBIDO_INDIRETO
FROM VCG8_CP_SAIDA_RESUMIDA_CALC CALC INNER JOIN #TMP_RECEBIDOS REC
	ON REC.COD_VERSAO           = CALC.COD_VERSAO       AND 
	   REC.COD_ATIVIDADE        = CALC.COD_ATIVIDADE    AND
	   REC.COD_BLOCO_CENTRO     = CALC.COD_BLOCO_CENTRO            INNER JOIN #TMP_ORIGEM ORIG
	ON ORIG.COD_VERSAO          = CALC.COD_VERSAO       AND
	   ORIG.COD_ATIVIDADE       = CALC.COD_ATIVIDADE 


	   -------------

	   SELECT  COD_VERSAO,
		       COD_ATIVIDADE AS COD_ATIVIDADE_DEP,
		       COD_BLOCO_CONTA,
		       ID_SUBCANAL_COMERC,
		       COD_PROD_FIN,
		       COD_BLOCO_CENTRO,
		       TIPO_EMPRESA,
		       ID_EMPRESA,
		       ID_ORGAO,
		       ID_CONTA,		
		       VL_LANCAMENTO_DIRETO,	
			   1 AS BASE               -- DIRETOS
	   FROM #TMP_DIRETO
	   UNION ALL
	   SELECT  COD_VERSAO,
		       COD_ATIVIDADE AS COD_ATIVIDADE_DEP,
		       COD_BLOCO_CONTA,
		       ID_SUBCANAL_COMERC,
		       COD_PROD_FIN,
		       COD_BLOCO_CENTRO,
		       TIPO_EMPRESA_ORIGEM AS TIPO_EMPRESA,
		       ID_EMPRESA_ORIGEM   AS ID_EMPRESA,
			   ID_ORGAO_ORIGEM     AS ID_ORGAO,
		       NULL AS ID_CONTA,		
		       VL_LANCAMENTO_RECEBIDO_INDIRETO,	
			   2 AS BASE               -- RECEBIDOS_INDIRETOS   
	   FROM #TMP_RECEBIDO_INDIRETO
	   UNION ALL 
	   SELECT  COD_VERSAO,
		       COD_ATIVIDADE AS COD_ATIVIDADE_DEP,
		       COD_BLOCO_CONTA,
		       ID_SUBCANAL_COMERC,
		       COD_PROD_FIN,
		       COD_BLOCO_CENTRO,
		       NULL AS TIPO_EMPRESA,
		       NULL AS ID_EMPRESA,
		       NULL AS ID_ORGAO,
		       NULL AS ID_CONTA,		
		       VL_LANCAMENTO,	
			   3 AS BASE               -- VALORES IRRELEVANTES   
	   FROM #VCG8_CP_SAIDA_RESUMIDA_CALC_AJ_AGRUP
	   	   UNION ALL 
	   SELECT  COD_VERSAO,
		       COD_ATIVIDADE AS COD_ATIVIDADE_DEP,
		       COD_BLOCO_CONTA,
		       ID_SUBCANAL_COMERC,
		       COD_PROD_FIN,
		       COD_BLOCO_CENTRO,
		       NULL AS TIPO_EMPRESA,
		       NULL AS ID_EMPRESA,
		       NULL AS ID_ORGAO,
		       NULL AS ID_CONTA,		
		       VL_LANCAMENTO,	
			   4 AS BASE               -- AJUSTES   
	   FROM #VCG8_CP_SAIDA_RESUMIDA_CALC_AJ

